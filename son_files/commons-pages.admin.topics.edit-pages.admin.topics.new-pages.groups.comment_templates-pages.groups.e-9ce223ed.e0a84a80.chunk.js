(this.webpackJsonp=this.webpackJsonp||[]).push([["commons-pages.admin.topics.edit-pages.admin.topics.new-pages.groups.comment_templates-pages.groups.e-9ce223ed"],{JTix:function(e,t,o){"use strict";o("UezY"),o("z6RN"),o("hG7+");var i=o("lCTV"),n=o("XGVf"),r=o("oCX2"),a=o("iPR/"),s=o("CbCZ"),d=o("hvGG"),l=o("L78D"),u=o("Q5rj"),c=o("ygVz"),p=o("RoRO"),m=o.n(p),h=o("nX46"),f=o.n(h),g=o("Mp8J"),v=o("FxFN"),w=o("4wgn"),y=o("tXF7"),b=o("0ENF"),k={name:"MarkdownComposer",apollo:{$subscribe:{composer:{query:f.a,variables(){return{resourceId:this.resourceId,userId:this.userId,htmlResponse:!0,clientSubscriptionId:this.composerSubscriptionID}},result({data:e}){if(!e.aiCompletionResponse)return;const{content:t,contentHtml:o}=e.aiCompletionResponse;this.aiContentPreview=t,this.aiContentPreviewHTML=o,this.aiContentPreviewLoading=!1}}}},directives:{SafeHtml:g.a},components:{GlButton:s.a,GlFormInput:d.a,GlFormGroup:l.a,GlSkeletonLoader:u.a},mixins:[c.a.mixin()],inject:["projectId","sourceBranch","targetBranch"],props:{markdown:{type:String,required:!0}},data:()=>({userPrompt:"",showComposer:!1,aiContentPreviewLoading:!1,aiContentPreview:null,aiContentPreviewHTML:null,cursorLocation:0,top:0}),computed:{resourceId(){return Object(v.c)(w.K,this.projectId)},userId:()=>Object(v.c)(w.P,gon.current_user_id),cursorText(){return this.markdown.substring(0,this.cursorLocation)},cursorAfterText(){return this.markdown.substring(this.cursorLocation)},composerSubscriptionID:()=>"composer-"+Object(a.a)()},mounted(){document.addEventListener("keyup",this.onDocumentKeyUp),b.a.$on("SHOW_COMPOSER",this.showComposerPopover),b.a.$on("CLOSE_COMPOSER",this.closeComposerPopover),this.textarea=this.$el.querySelector("textarea"),this.textarea&&(this.textarea.addEventListener("mouseup",this.onKeyUp),this.textarea.addEventListener("keyup",this.onKeyUp),this.textarea.addEventListener("scroll",this.onScroll))},beforeDestroy(){document.removeEventListener("keyup",this.onDocumentKeyUp),b.a.$off("SHOW_COMPOSER",this.showComposerPopover),b.a.$off("CLOSE_COMPOSER",this.closeComposerPopover),this.textarea&&(this.textarea.removeEventListener("mouseup",this.onKeyUp),this.textarea.removeEventListener("keyup",this.onKeyUp),this.textarea.removeEventListener("scroll",this.onScroll))},methods:{showComposerPopover(){this.showComposer=!0},closeComposerPopover(){this.showComposer=!1,this.discardAIContent()},onDocumentKeyUp(e){this.showComposer&&"Escape"===e.key&&this.closeComposerPopover()},onKeyUp(){this.cursorLocation=this.textarea.selectionEnd,this.calculateTop()},onScroll(){this.$refs.textContainer.scrollTo(0,this.textarea.scrollTop),this.calculateTop()},calculateTop(){var e=this;this.$nextTick((function(){const t=e.$refs.text.offsetTop+e.$refs.text.offsetHeight-e.textarea.scrollTop;e.top=Math.min(e.textarea.offsetHeight,Math.max(0,t))+8}))},submitComposer(){var e,t,o,i,n,r,a;let s=this.markdown||"";s=`${s.slice(0,(null===(e=this.textarea)||void 0===e?void 0:e.selectionStart)||0)}<selected-text>${s.slice((null===(t=this.textarea)||void 0===t?void 0:t.selectionStart)||0,(null===(o=this.textarea)||void 0===o?void 0:o.selectionEnd)||0)}</selected-text>${s.slice((null===(i=this.textarea)||void 0===i?void 0:i.selectionEnd)||0)}`,this.aiContentPreviewLoading=!0,this.$apollo.mutate({mutation:m.a,variables:{input:{descriptionComposer:{resourceId:this.resourceId,sourceProjectId:this.projectId,sourceBranch:this.sourceBranch,targetBranch:this.targetBranch,description:s,title:null!==(n=null===(r=document.querySelector(".js-issuable-title"))||void 0===r?void 0:r.value)&&void 0!==n?n:"",userPrompt:this.userPrompt||"",previousResponse:null!==(a=this.aiContentPreview)&&void 0!==a?a:""},clientSubscriptionId:this.composerSubscriptionID}}})},insertAiContent(){Object(y.g)({textArea:this.textarea,tag:this.aiContentPreview,cursorOffset:0,wrap:!1,replaceText:!0}),this.closeComposerPopover()},discardAIContent(){this.aiContentPreview=null,this.aiContentPreviewHTML=null,this.userPrompt=""}}},C=o("tBpV"),x=Object(C.a)(k,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"gl-relative"},[e._t("default"),e._v(" "),t("div",{staticClass:"gl-absolute gl-bottom-0 gl-left-0 gl-right-0 gl-top-[-2px] gl-overflow-auto gl-overflow-x-hidden gl-border-2 gl-border-solid gl-border-transparent gl-px-[14px] gl-py-[12px]"},[t("div",{ref:"textContainer"},[t("div",{staticClass:"gfm-input-text markdown-area gl-invisible !gl-font-monospace gl-whitespace-pre-wrap gl-border-0 gl-p-0 !gl-max-h-fit",staticStyle:{"word-wrap":"break-word"}},[e._v(e._s(e.cursorText)),t("span",{ref:"text"},[e._v("|")]),e._v(e._s(e.cursorAfterText))])])]),e._v(" "),e.showComposer?t("div",{staticClass:"gl-absolute gl-left-5 gl-right-5 gl-top-0 gl-z-4 gl-overflow-hidden gl-rounded-lg gl-border-1 gl-border-solid gl-border-dropdown gl-bg-dropdown gl-shadow-md",class:{"gl-pt-0":e.aiContentPreview},style:`top: ${e.top}px`},[e.aiContentPreviewLoading||e.aiContentPreview?t("div",{staticClass:"gl-border-b-1 gl-border-dropdown gl-bg-gray-50 gl-p-4 gl-border-b-solid"},[e.aiContentPreviewLoading?t("gl-skeleton-loader",{attrs:{lines:3}}):e.aiContentPreview?t("div",{directives:[{name:"safe-html",rawName:"v-safe-html",value:e.aiContentPreview,expression:"aiContentPreview"}],staticClass:"md gl-max-h-[200px] gl-overflow-y-auto gl-whitespace-pre-wrap gl-font-monospace"}):e._e()],1):e._e(),e._v(" "),t("div",{staticClass:"gl-p-4"},[t("gl-form-group",{attrs:{label:e.__("Describe what you want to write"),"label-for":"composer-user-prompt"}},[t("gl-form-input",{attrs:{id:"composer-user-prompt",placeholder:e.__("Ask GitLab Duo to help you write descriptions, rewrite existing text and more..."),autocomplete:"off",autofocus:"","data-testid":"composer-user-prompt",disabled:e.aiContentPreviewLoading},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:(t.preventDefault(),t.stopPropagation(),e.submitComposer.apply(null,arguments))}},model:{value:e.userPrompt,callback:function(t){e.userPrompt=t},expression:"userPrompt"}})],1),e._v(" "),t("div",{staticClass:"gl-flex gl-justify-end gl-gap-3"},[e.aiContentPreview?t("gl-button",{attrs:{variant:"danger",category:"tertiary","data-testid":"composer-discard"},on:{click:e.discardAIContent}},[e._v(e._s(e.s__("AI|Discard suggestion")))]):e._e(),e._v(" "),t("gl-button",{attrs:{variant:e.aiContentPreview?"default":"confirm",loading:e.aiContentPreviewLoading,"data-testid":"composer-submit"},on:{click:e.submitComposer}},[e.aiContentPreview?[e._v(e._s(e.s__("AI|Regenerate")))]:[e._v(e._s(e.s__("AI|Generate")))]],2),e._v(" "),e.aiContentPreview?t("gl-button",{attrs:{variant:"confirm","data-testid":"composer-insert"},on:{click:e.insertAiContent}},[e._v(e._s(e.s__("AI|Accept & Insert")))]):e._e()],1)],1)]):e._e()],2)}),[],!1,null,null,null).exports,_=o("/lV4"),E=o("2ibD"),A=o("4UiK"),P=o("3twG"),S=o("CqXh"),T=o("5c3i"),O=o("IeAI");async function M(e,t=10,o=2e3){if(o<=0)return null;const i=e();return i||(await async function(e=10){return new Promise((function(t){setTimeout(t,e)}))}(t),M(e,o-t))}var $={components:{GlAlert:i.a,MarkdownField:O.a,LocalStorageSync:S.a,MarkdownComposer:x,ContentEditor:function(){return Promise.all([o.e("prosemirror"),o.e("vendors-content_editor-gfm_copy_extra"),o.e("content_editor")]).then(o.bind(null,"Er7F"))}},directives:{Outside:n.a},inject:{canUseComposer:{default:!1}},props:{value:{type:String,required:!0},setFacade:{type:Function,required:!1,default:null},renderMarkdownPath:{type:String,required:!0},uploadsPath:{type:String,required:!1,default:function(){return window.uploads_path||""}},enableContentEditor:{type:Boolean,required:!1,default:!0},formFieldProps:{type:Object,required:!0},autofocus:{type:Boolean,required:!1,default:!1},enableAutocomplete:{type:Boolean,required:!1,default:!0},autocompleteDataSources:{type:Object,required:!1,default:function(){return{}}},supportsQuickActions:{type:Boolean,required:!1,default:!1},supportsTableOfContents:{type:Boolean,required:!1,default:!1},autosaveKey:{type:String,required:!1,default:null},markdownDocsPath:{type:String,required:!1,default:""},drawioEnabled:{type:Boolean,required:!1,default:!1},disabled:{type:Boolean,required:!1,default:!1},disableAttachments:{type:Boolean,required:!1,default:!1},codeSuggestionsConfig:{type:Object,required:!1,default:function(){return{}}},noteableType:{type:String,required:!1,default:""},restrictedToolBarItems:{type:Array,required:!1,default:function(){return[]}},restoreFromAutosave:{type:Boolean,required:!1,default:!1},newCommentTemplatePaths:{type:Array,required:!1,default:function(){return[]}},editorAiActions:{type:Array,required:!1,default:function(){return[]}},immersive:{type:Boolean,required:!1,default:!1}},data(){var e;let t;switch(null===(e=window.gon)||void 0===e?void 0:e.text_editor){case"rich_text_editor":t=T.g;break;case"plain_text_editor":t=T.i;break;default:t=localStorage.getItem(this.$options.EDITING_MODE_KEY)||T.i}const o=this.autosaveKey?Object(A.c)(this.autosaveKey):"";return{alert:null,markdown:(this.restoreFromAutosave?o:this.value)||o||"",editingMode:t,autofocused:!1}},computed:{isContentEditorActive(){return this.enableContentEditor&&this.editingMode===T.g},contentEditorAutofocused(){return!(!this.autofocus||this.autofocused)&&"end"},markdownFieldRestrictedToolBarItems(){const e=this.disableAttachments?["attach-file"]:[];return[...this.restrictedToolBarItems,...e]},isDefaultEditorEnabled(){var e;return["plain_text_editor","rich_text_editor"].includes(null===(e=window.gon)||void 0===e?void 0:e.text_editor)},composerComponent(){return this.canUseComposer?"markdown-composer":"div"}},watch:{value:"updateValue"},mounted(){var e,t=this;this.autofocusTextarea(),this.$emit("input",this.markdown,!0),this.saveDraft(),null===(e=this.setFacade)||void 0===e||e.call(this,{getValue:function(){return t.getValue()},setValue:function(e){return t.setValue(e)}}),b.a.$on(T.c,this.clearDraft)},beforeDestroy(){b.a.$off(T.c,this.clearDraft)},methods:{getValue(){return this.markdown},setValue(e){this.$emit("input",e),this.updateValue(e)},updateValue(e){this.markdown=e,this.saveDraft(),this.autosizeTextarea()},append(e){var t=this;if(!e)return void this.focus();const o=[this.markdown.trim(),e].filter(Boolean).join("\n\n");this.updateValue(o+"\n\n"),this.$nextTick((function(){t.focus()}))},setTemplate(e,t=!1){var o=this;if(!this.markdown||t)this.setValue(e);else{const t=function(){o.alert=null};this.alert={message:this.$options.i18n.applyTemplateAlert.message,variant:"warning",primaryButtonText:this.$options.i18n.applyTemplateAlert.primaryButtonText,secondaryButtonText:this.$options.i18n.applyTemplateAlert.secondaryButtonText,primaryAction:function(){o.setValue(e,!0),t()},secondaryAction:t,dismiss:t}}},updateMarkdownFromContentEditor({markdown:e}){this.markdown=e,this.$emit("input",e),this.saveDraft()},updateMarkdownFromMarkdownField({target:e}){this.markdown=e.value,this.$emit("input",e.value),this.saveDraft()},renderMarkdown(e){const t=Object(P.L)({render_quick_actions:this.supportsQuickActions,no_header_anchors:!this.supportsTableOfContents},{url:Object(P.y)(window.location.origin,this.renderMarkdownPath)});return E.a.post(t,{text:e}).then((function({data:{html:e,body:t,...o}={}}={}){return{body:t||e||"",...o}}))},onEditingModeChange(e){this.editingMode=e,this.notifyEditingModeChange(e)},onEditingModeRestored(e){this.isDefaultEditorEnabled&&(e!==T.g||this.enableContentEditor?(this.editingMode=e,this.$emit(e),this.notifyEditingModeChange(e)):this.editingMode=T.i)},async notifyEditingModeChange(e){var t=this;this.$emit(e);const o=e===T.g?function(){return t.$refs.contentEditor}:function(){return t.$refs.textarea};(await M(o)).focus()},autofocusTextarea(){this.autofocus&&this.editingMode===T.i&&(this.$refs.textarea.focus(),this.setEditorAsAutofocused())},focus(){this.editingMode===T.i?this.$refs.textarea.focus():this.$refs.contentEditor.focus()},setEditorAsAutofocused(){this.autofocused=!0},saveDraft(){this.autosaveKey&&(this.markdown?Object(A.e)(this.autosaveKey,this.markdown):Object(A.a)(this.autosaveKey))},clearDraft(e){this.autosaveKey&&e===this.autosaveKey&&Object(A.a)(this.autosaveKey)},togglePreview(e){this.editingMode===T.i&&(this.$refs.markdownField.previewMarkdown=e)},autosizeTextarea(){var e=this;this.editingMode===T.i&&this.$nextTick((function(){r.a.update(e.$refs.textarea)}))},onKeydown(e){(e.ctrlKey||e.metaKey)&&"k"===e.key&&e.preventDefault(),this.$emit("keydown",e)},onClickOutside(){this.canUseComposer&&b.a.$emit("CLOSE_COMPOSER")}},EDITING_MODE_KEY:T.h,i18n:{applyTemplateAlert:{message:Object(_.a)("Applying a template will replace the existing content. Any changes you have made will be lost."),primaryButtonText:Object(_.a)("Apply template"),secondaryButtonText:Object(_.a)("Cancel")}}},D=Object(C.a)($,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"js-editor md-area-wrapper gl-rounded-lg !gl-px-0",class:{"gl-relative":!e.immersive}},[e.isDefaultEditorEnabled?e._e():t("local-storage-sync",{attrs:{value:e.editingMode,"as-string":"","storage-key":e.$options.EDITING_MODE_KEY},on:{input:e.onEditingModeRestored}}),e._v(" "),e.alert?t("gl-alert",{staticClass:"gl-mb-4",attrs:{variant:e.alert.variant,"primary-button-text":e.alert.primaryButtonText,"secondary-button-text":e.alert.secondaryButtonText},on:{primaryAction:e.alert.primaryAction,secondaryAction:e.alert.secondaryAction,dismiss:e.alert.dismiss}},[e._v("\n    "+e._s(e.alert.message)+"\n  ")]):e._e(),e._v(" "),e.isContentEditorActive?t("div",[t("content-editor",{ref:"contentEditor",attrs:{"render-markdown":e.renderMarkdown,"markdown-docs-path":e.markdownDocsPath,"new-comment-template-paths":e.newCommentTemplatePaths,"uploads-path":e.uploadsPath,markdown:e.markdown,"supports-quick-actions":e.supportsQuickActions,"supports-table-of-contents":e.supportsTableOfContents,autofocus:e.contentEditorAutofocused,placeholder:e.formFieldProps.placeholder,"drawio-enabled":e.drawioEnabled,"enable-autocomplete":e.enableAutocomplete,"autocomplete-data-sources":e.autocompleteDataSources,editable:!e.disabled,"disable-attachments":e.disableAttachments,"code-suggestions-config":e.codeSuggestionsConfig,immersive:e.immersive,"data-testid":e.formFieldProps["data-testid"]||"markdown-editor-form-field"},on:{initialized:e.setEditorAsAutofocused,change:e.updateMarkdownFromContentEditor,keydown:e.onKeydown,enableMarkdownEditor:function(t){return e.onEditingModeChange("markdownField")},focus:function(t){return e.$emit("focus")},blur:function(t){return e.$emit("blur")}},scopedSlots:e._u([{key:"header",fn:function(){return[e._t("header")]},proxy:!0},{key:"header-buttons",fn:function(){return[e._t("header-buttons")]},proxy:!0},{key:"toolbar",fn:function(){return[e._t("toolbar")]},proxy:!0}],null,!0)}),e._v(" "),t("input",e._b({attrs:{type:"hidden"},domProps:{value:e.markdown}},"input",e.formFieldProps,!1))],1):t("markdown-field",e._b({ref:"markdownField",attrs:{"data-testid":"markdown-field","markdown-preview-path":e.renderMarkdownPath,"new-comment-template-paths":e.newCommentTemplatePaths,"can-attach-file":!e.disableAttachments,"can-suggest":e.codeSuggestionsConfig.canSuggest,"editor-ai-actions":e.editorAiActions,line:e.codeSuggestionsConfig.line,lines:e.codeSuggestionsConfig.lines,"show-suggest-popover":e.codeSuggestionsConfig.showPopover,"textarea-value":e.markdown,"uploads-path":e.uploadsPath,"enable-autocomplete":e.enableAutocomplete,"autocomplete-data-sources":e.autocompleteDataSources,"markdown-docs-path":e.markdownDocsPath,"supports-quick-actions":e.supportsQuickActions,"supports-table-of-contents":e.supportsTableOfContents,"show-content-editor-switcher":e.enableContentEditor,"drawio-enabled":e.drawioEnabled,immersive:e.immersive,"restricted-tool-bar-items":e.markdownFieldRestrictedToolBarItems},on:{enableContentEditor:function(t){return e.onEditingModeChange("contentEditor")},handleSuggestDismissed:function(){return e.$emit("handleSuggestDismissed")}},scopedSlots:e._u([{key:"header",fn:function(){return[e._t("header")]},proxy:!0},{key:"header-buttons",fn:function(){return[t("div",[e._t("header-buttons")],2)]},proxy:!0},{key:"toolbar",fn:function(){return[e._t("toolbar")]},proxy:!0},{key:"textarea",fn:function(){return[t(e.composerComponent,{directives:[{name:"outside",rawName:"v-outside",value:e.onClickOutside,expression:"onClickOutside"}],tag:"component",attrs:{markdown:e.canUseComposer?e.markdown:null}},[t("textarea",e._b({ref:"textarea",staticClass:"note-textarea js-gfm-input markdown-area",class:[{"gl-relative gl-z-3":e.canUseComposer,"focus:gl-outline-none":e.immersive},e.formFieldProps.class||""],attrs:{dir:"auto","data-can-suggest":e.codeSuggestionsConfig.canSuggest,"data-noteable-type":e.noteableType,"data-supports-quick-actions":e.supportsQuickActions,"data-testid":e.formFieldProps["data-testid"]||"markdown-editor-form-field",disabled:e.disabled},domProps:{value:e.markdown},on:{input:e.updateMarkdownFromMarkdownField,keydown:function(t){return e.$emit("keydown",t)},focus:function(t){return e.$emit("focus")},blur:function(t){return e.$emit("blur")}}},"textarea",e.formFieldProps,!1))])]},proxy:!0}],null,!0)},"markdown-field",e.$attrs,!1))],1)}),[],!1,null,null,null);t.a=D.exports},RoRO:function(e,t){var o={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AiAction"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"input"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"AiActionInput"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"aiAction"},arguments:[{kind:"Argument",name:{kind:"Name",value:"input"},value:{kind:"Variable",name:{kind:"Name",value:"input"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"errors"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:89}};o.loc.source={body:"mutation AiAction($input: AiActionInput!) {\n  aiAction(input: $input) {\n    errors\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};var i={};function n(e,t){for(var o=0;o<e.definitions.length;o++){var i=e.definitions[o];if(i.name&&i.name.value==t)return i}}o.definitions.forEach((function(e){if(e.name){var t=new Set;!function e(t,o){if("FragmentSpread"===t.kind)o.add(t.name.value);else if("VariableDefinition"===t.kind){var i=t.type;"NamedType"===i.kind&&o.add(i.name.value)}t.selectionSet&&t.selectionSet.selections.forEach((function(t){e(t,o)})),t.variableDefinitions&&t.variableDefinitions.forEach((function(t){e(t,o)})),t.definitions&&t.definitions.forEach((function(t){e(t,o)}))}(e,t),i[e.name.value]=t}})),e.exports=o,e.exports.AiAction=function(e,t){var o={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(o.loc=e.loc);var r=i[t]||new Set,a=new Set,s=new Set;for(r.forEach((function(e){s.add(e)}));s.size>0;){var d=s;s=new Set,d.forEach((function(e){a.has(e)||(a.add(e),(i[e]||new Set).forEach((function(e){s.add(e)})))}))}return a.forEach((function(t){var i=n(e,t);i&&o.definitions.push(i)})),o}(o,"AiAction")}}]);
//# sourceMappingURL=commons-pages.admin.topics.edit-pages.admin.topics.new-pages.groups.comment_templates-pages.groups.e-9ce223ed.e0a84a80.chunk.js.map